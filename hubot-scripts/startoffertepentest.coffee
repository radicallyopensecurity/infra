# Description:
#   create a channel, repo, kanboard for an offerte or pentest.
#
# Notes:
# Commands:
#   startofferte OFFERTENAME - create a channel, repo, kanboard for an offerte (limited to authorized users)
#   startpentest PENTESTNAME - create a channel, repo, kanboard for a pentest (limited to authorized users)


module.exports = (robot) ->
  robot.respond /startofferte (.*)/i, (msg) ->
    msg.match[0] = msg.match[0].replace(/^[a-z0-9]+$/i);
    msg.match.shift();
    accesstest = 0;
# expand this to other users as required
    if res.envelope.user.name == "YOURUSERNAME"
      accesstest = 1;
    if accesstest == 0 
      res.send "I am sorry " + res.envelope.user.name + " but I have not been told you are allowed to ask for that"
      return;
    args = msg.match[0].split(" ");
    if args[0].substring(0, 4) == "pen-"
      msg.send "[-] Please do not start offerte names with pen-";
      return;
    if args[0].substring(0, 4) == "off-"
      msg.send "[-] Please do not start offerte names with off-";
      return;
    msg.send "[+] ok, hold, setting up offerte " + args[0];
    roomName = args[0];
    newroom = robot.adapter.callMethod('createPrivateGroup', "off-" + roomName, ['YOURUSERNAME', 'OTHERDEFAULTUSERNAME'])
    msg.send  "[+] new channel created- Added YOURUSERNAME and OTHERDEFAULTUSERNAME to the new room " + "pen-" + roomName
    newroom.then (roomId) =>
      robot.messageRoom roomId.rid, "@all hello!"
    cmd = "php/handler_offerte";
    run_cmd cmd, args, (text) -> msg.send text.replace("\n","");

  robot.respond /startpentest (.*)/i, (msg) ->
    msg.match[0] = msg.match[0].replace(/^[a-z0-9]+$/i);
    msg.match.shift();
    accesstest = 0;
# expand this to other users as required
    if res.envelope.user.name == "YOURUSERNAME"
      accesstest = 1;
    if accesstest == 0 
      res.send "I am sorry " + res.envelope.user.name + " but I have not been told you are allowed to ask for that"
      return;
    args = msg.match[0].split(" ");
    if args[0].substring(0, 4) == "off-"
      msg.send "[-] Please do not start pen names with off-";
      return;
    if args[0].substring(0, 4) == "pen-"
      msg.send "[-] Please do not start pen names with pen-";
      return;
    msg.send "[+] ok, hold, setting up pentest " + args[0];
    roomName = args[0];
    newroom = robot.adapter.callMethod('createPrivateGroup', "pen-" + roomName, ['YOURUSERNAME', 'OTHERDEFAULTUSERNAME'])
    msg.send  "[+] new channel created- Added YOURUSERNAME and OTHERDEFAULTUSERNAME to the new room " + "pen-" + roomName
    newroom.then (roomId) =>
      robot.messageRoom roomId.rid, "@all hello!"
      args[1] = roomId.rid
    cmd = "php/handler_pentest";
    run_cmd cmd, args, (text) -> msg.send text.replace("\n","");

